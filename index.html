<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DutyPlanner Pro - Ucha Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --dark-red: #8b0000;
            --bg: #f8f9fd;
            --sidebar-bg: #1e1e2d;
            --weekend-bg: #fff5f5;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Panels */
        #sidebar { width: 320px; background: var(--sidebar-bg); color: white; padding: 20px; overflow-y: auto; display: none; flex-direction: column; flex-shrink: 0; }
        #main { flex-grow: 1; padding: 20px; overflow-y: auto; }
        #right-panel { width: 320px; padding: 20px; background: white; border-left: 1px solid #ddd; display: none; flex-direction: column; flex-shrink: 0; }

        .admin-active #sidebar, .admin-active #right-panel { display: flex; }
        .admin-active #sidebar { display: block; }

        input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 8px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 900px; margin: 0 auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .weekend { background-color: var(--weekend-bg) !important; color: #ef233c; }

        .staff-item { background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; font-size: 13px; }
        .remove-btn { color: #ff4d4d; cursor: pointer; font-weight: bold; font-size: 16px; }

        .login-btn { position: fixed; bottom: 10px; right: 10px; opacity: 0.2; cursor: pointer; background: none; border: none; font-size: 11px; }
        .btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-green { background: #2ecc71; color: white; }
        .btn-pdf { background: #e67e22; color: white; margin-top: 10px; }
        
        #codeOutput { flex-grow: 1; background: #1e1e1e; color: #4ade80; padding: 10px; font-family: monospace; font-size: 11px; border-radius: 5px; resize: none; border: none; }

        @media (max-width: 600px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 12px; border-radius: 8px; background: white; overflow:hidden;}
            td { border: none; position: relative; padding-left: 45%; border-bottom: 1px solid #eee; min-height: 40px; display: flex; align-items: center; }
            td:before { position: absolute; left: 10px; width: 40%; font-weight: bold; color: #666; font-size: 12px; }
            td:nth-of-type(1):before { content: "áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜:"; }
            td:nth-of-type(2):before { content: "áƒ“áƒ áƒ:"; }
            td:nth-of-type(3):before { content: "áƒ›áƒáƒ áƒ˜áƒ’áƒ”:"; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="text-align:center">ğŸ›  áƒ›áƒáƒ áƒ—áƒ•áƒ</h2>
    <label style="font-size:12px; color:#aaa;">áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ˜</label>
    <input type="month" id="startMonth" onchange="saveSettings()">
    <input type="month" id="endMonth" onchange="saveSettings()">
    
    <hr style="opacity:0.1; margin:15px 0;">
    <label style="font-size:12px; color:#aaa;">áƒáƒ”áƒ áƒ¡áƒáƒœáƒáƒšáƒ˜</label>
    <input type="text" id="staffName" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
    <input type="text" id="staffPhone" placeholder="áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜">
    <button class="btn btn-primary" onclick="addStaff()">áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
    <div id="staffListUI" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
    
    <hr style="opacity:0.1; margin:15px 0;">
    <button class="btn btn-green" onclick="generateNew()">ğŸ”„ áƒ’áƒ”áƒœáƒ”áƒ áƒ˜áƒ áƒ”áƒ‘áƒ</button>
    <button class="btn btn-pdf" onclick="exportPDF()">ğŸ“„ PDF áƒ”áƒ¥áƒ¡áƒáƒáƒ áƒ¢áƒ˜</button>
    <button class="btn" style="background:#e74c3c; color:white; margin-top:20px;" onclick="location.reload()">ğŸ”’ áƒ’áƒáƒ›áƒáƒ¡áƒ•áƒšáƒ</button>
</div>

<div id="main">
    <div class="card" id="printable-content">
        <div id="displayTitle" style="color:var(--dark-red); text-align:center; font-size:26px; font-weight:800;">áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜</div>
        <div id="displayHeaderPhone" style="text-align:center; margin:15px 0;"></div>
        
        <div id="adminInputs" style="display:none; gap:10px; margin-bottom:20px">
            <input type="text" id="topTitleInput" placeholder="áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜" oninput="updateUI()" style="color:#333; background:#eee">
            <input type="text" id="topPhoneInput" placeholder="áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜" oninput="updateUI()" style="color:#333; background:#eee">
        </div>
        
        <div id="scheduleContainer"></div>
    </div>
</div>

<div id="right-panel">
    <h3>ğŸ’» áƒ™áƒáƒ“áƒ˜</h3>
    <textarea id="codeOutput" readonly></textarea>
    <button class="btn btn-primary" style="margin-top:10px" onclick="copyHTML()">ğŸ“‹ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ</button>
</div>

<button class="login-btn" onclick="login()">ğŸ”‘ Admin</button>

<script>
    const U = "áƒ£áƒ©áƒ";
    const P = "20261";

    let staff = JSON.parse(localStorage.getItem('savedStaffContacts')) || [];
    let settings = JSON.parse(localStorage.getItem('ucha_settings')) || {
        title: "áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜",
        phones: "",
        startMonth: "",
        endMonth: "",
        lastSchedule: ""
    };

    function login() {
        const userIn = prompt("áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜:");
        const passIn = prompt("áƒáƒáƒ áƒáƒšáƒ˜:");
        if (userIn === U && passIn === P) {
            document.body.classList.add('admin-active');
            document.getElementById('adminInputs').style.display = 'flex';
            renderStaffUI();
        } else {
            alert("áƒ¬áƒ•áƒ“áƒáƒ›áƒ áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ˜áƒšáƒ˜áƒ!");
        }
    }

    function addStaff() {
        const n = document.getElementById('staffName'), p = document.getElementById('staffPhone');
        if(n.value.trim()) {
            staff.push({ name: n.value.trim(), phone: p.value.trim() || "---" });
            staff.sort((a,b) => a.name.localeCompare(b.name, 'ka'));
            localStorage.setItem('savedStaffContacts', JSON.stringify(staff));
            n.value = ""; p.value = ""; renderStaffUI();
        }
    }

    function renderStaffUI() {
        document.getElementById('staffListUI').innerHTML = staff.map((s, i) => `
            <div class="staff-item">
                <span>${s.name}</span>
                <span class="remove-btn" onclick="removeStaff(${i})">Ã—</span>
            </div>`).join('');
    }

    function removeStaff(i) {
        staff.splice(i, 1);
        localStorage.setItem('savedStaffContacts', JSON.stringify(staff));
        renderStaffUI();
    }

    function updateUI() {
        settings.title = document.getElementById('topTitleInput').value || "áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜";
        settings.phones = document.getElementById('topPhoneInput').value;
        document.getElementById('displayTitle').innerText = settings.title;
        const area = document.getElementById('displayHeaderPhone');
        area.innerHTML = settings.phones.split(/[, ]+/).filter(x => x).map(p => 
            `<a href="tel:${p}" style="display:inline-block; color:white; background:var(--dark-red); text-decoration:none; padding:8px 12px; border-radius:20px; margin:4px; font-weight:bold; font-size:12px;">ğŸ“ ${p}</a>`
        ).join('');
        saveSettings();
        syncCode();
    }

    function saveSettings() {
        settings.startMonth = document.getElementById('startMonth').value;
        settings.endMonth = document.getElementById('endMonth').value;
        localStorage.setItem('ucha_settings', JSON.stringify(settings));
    }

    function generateNew() {
        const s = document.getElementById('startMonth').value;
        const e = document.getElementById('endMonth').value;
        if(!s || !e || staff.length === 0) return alert("áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜!");

        let cur = new Date(Date.UTC(s.split('-')[0], s.split('-')[1]-1, 1));
        const endLimit = new Date(Date.UTC(e.split('-')[0], e.split('-')[1], 0));
        let html = ""; let idx = 0;
        const months = ["áƒ˜áƒáƒœáƒ•áƒáƒ áƒ˜", "áƒ—áƒ”áƒ‘áƒ”áƒ áƒ•áƒáƒšáƒ˜", "áƒ›áƒáƒ áƒ¢áƒ˜", "áƒáƒáƒ áƒ˜áƒšáƒ˜", "áƒ›áƒáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒœáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒšáƒ˜áƒ¡áƒ˜", "áƒáƒ’áƒ•áƒ˜áƒ¡áƒ¢áƒ", "áƒ¡áƒ”áƒ¥áƒ¢áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒáƒ¥áƒ¢áƒáƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒœáƒáƒ”áƒ‘áƒ”áƒ áƒ˜", "áƒ“áƒ”áƒ™áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜"];

        while(cur <= endLimit) {
            if(cur.getUTCDate() === 1) {
                if(html !== "") html += "</tbody></table>";
                html += `<h3 style="color:var(--dark-red); background:#f1f4f8; padding:10px; margin-top:20px;">${months[cur.getUTCMonth()]} ${cur.getUTCFullYear()}</h3>
                         <table><thead><tr><th>áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜</th><th>áƒ“áƒ áƒ</th><th>áƒ›áƒáƒ áƒ˜áƒ’áƒ”</th></tr></thead><tbody>`;
            }
            const isW = (cur.getUTCDay() === 0 || cur.getUTCDay() === 6);
            const p = staff[idx % staff.length];
            html += `<tr class="${isW?'weekend':''}"><td><b>${cur.getUTCDate()}</b></td><td><small>${isW?'08:00-03:00':'18:00-03:00'}</small></td><td><b>${p.name}</b><br><small>ğŸ“ ${p.phone}</small></td></tr>`;
            idx++; cur.setUTCDate(cur.getUTCDate() + 1);
        }
        const finalTable = html + "</tbody></table>";
        document.getElementById('scheduleContainer').innerHTML = finalTable;
        settings.lastSchedule = finalTable;
        saveSettings();
        syncCode();
    }

    function exportPDF() {
        const element = document.getElementById('printable-content');
        const opt = {
            margin: 10,
            filename: 'ganrigi.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function syncCode() {
        const title = document.getElementById('displayTitle').innerText;
        const phones = document.getElementById('displayHeaderPhone').innerHTML;
        const table = document.getElementById('scheduleContainer').innerHTML;
        const style = `<style>body{font-family:sans-serif; background:#f4f4f4; padding:15px;} .t{color:#8b0000; text-align:center; font-size:24px; font-weight:bold;} .p-cont{text-align:center; margin:20px 0;} table{width:100%; border-collapse:collapse; background:white; margin-bottom:20px;} th,td{border:1px solid #ddd; padding:10px; text-align:left;} .weekend{background:#fff5f5; color:#ef233c;} a{color:#4361ee; text-decoration:none; font-weight:bold;} @media (max-width: 600px) { table, thead, tbody, th, td, tr { display: block; } thead tr { position: absolute; top: -9999px; } tr { border: 1px solid #ccc; margin-bottom: 12px; border-radius: 8px; background: white; overflow:hidden;} td { border: none; position: relative; padding-left: 45%; border-bottom: 1px solid #eee; min-height: 40px; display: flex; align-items: center; } td:before { position: absolute; left: 10px; width: 40%; font-weight: bold; color: #666; font-size: 13px; } td:nth-of-type(1):before { content: "áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜:"; } td:nth-of-type(2):before { content: "áƒ“áƒ áƒ:"; } td:nth-of-type(3):before { content: "áƒ›áƒáƒ áƒ˜áƒ’áƒ”:"; } }</style>`;
        document.getElementById('codeOutput').value = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">${style}</head><body><div class="t">${title}</div><div class="p-cont">${phones}</div>${table}</body></html>`;
    }

    function copyHTML() {
        document.getElementById("codeOutput").select();
        document.execCommand("copy");
        alert("áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ“áƒ!");
    }

    window.onload = () => {
        document.getElementById('topTitleInput').value = settings.title;
        document.getElementById('topPhoneInput').value = settings.phones;
        document.getElementById('startMonth').value = settings.startMonth;
        document.getElementById('endMonth').value = settings.endMonth;
        document.getElementById('scheduleContainer').innerHTML = settings.lastSchedule || '<p style="text-align:center; color:#999; padding:50px;">áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ.</p>';
        updateUI();
    };
</script>
</body>
</html>
