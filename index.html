<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DutyPlanner Pro - Final Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --dark-red: #8b0000;
            --bg: #f8f9fd;
            --sidebar-bg: #1e1e2d;
            --weekend-bg: #fff5f5;
            --weekend-text: #ef233c;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout */
        #sidebar { width: 300px; background: var(--sidebar-bg); color: white; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        #main { flex-grow: 1; padding: 20px; overflow-y: auto; }
        #right-panel { width: 320px; padding: 20px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; }

        input, select {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box;
        }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .main-title { color: var(--dark-red); font-size: 1.8rem; font-weight: 800; text-align: center; margin-bottom: 15px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .weekend { background-color: var(--weekend-bg) !important; color: var(--weekend-text); }

        .editable-name {
            font-weight: bold; cursor: pointer; padding: 4px 8px; display: inline-block;
            border-radius: 4px; border: 1px dashed #4361ee; color: #333;
        }

        .phone-display { color: var(--primary); font-weight: bold; display: block; margin-top: 5px; text-decoration: none; font-size: 0.9rem; }
        
        #codeOutput { flex-grow: 1; font-family: monospace; font-size: 11px; background: #1e1e1e; color: #4ade80; padding: 10px; border-radius: 5px; resize: none; }

        .btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="text-align:center">DutyPlanner</h2>
    <label>ğŸ“… áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ˜</label>
    <input type="month" id="startMonth">
    <input type="month" id="endMonth" style="margin-top:5px">
    <hr style="opacity:0.2; margin:15px 0">
    <label>ğŸ‘¥ áƒáƒ”áƒ áƒ¡áƒáƒœáƒáƒšáƒ˜</label>
    <input type="text" id="staffName" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
    <input type="text" id="staffPhone" placeholder="áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜" style="margin-top:5px">
    <button class="btn btn-primary" onclick="addStaff()">áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
    <div id="staffListUI" style="margin-top:10px"></div>
    <button class="btn btn-primary" style="background:#2ecc71" onclick="generateNew()">ğŸ”„ áƒ’áƒ”áƒœáƒ”áƒ áƒ˜áƒ áƒ”áƒ‘áƒ</button>
</div>

<div id="main">
    <div class="card" id="printArea">
        <div id="displayTitle" class="main-title">áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜</div>
        <div id="displayHeaderPhone" style="text-align:center; margin-bottom:15px"></div>
        
        <div style="display:flex; gap:10px; margin-bottom:15px">
            <input type="text" id="topTitleInput" placeholder="áƒ¨áƒ”áƒªáƒ•áƒáƒšáƒ”áƒ— áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜" oninput="updateUI()" style="color:#333; background:#f0f0f0">
            <input type="text" id="topPhoneInput" placeholder="áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜ (áƒ›áƒáƒ’: 599...)" oninput="updateUI()" style="color:#333; background:#f0f0f0">
        </div>

        <div id="scheduleContainer"></div>
    </div>
</div>

<datalist id="staffDatalist"></datalist>

<div id="right-panel">
    <h3>ğŸ’» HTML áƒ™áƒáƒ“áƒ˜</h3>
    <p style="font-size:11px; color:#666">áƒ”áƒ¡ áƒ™áƒáƒ“áƒ˜ áƒ›áƒ–áƒáƒ“ áƒáƒ áƒ˜áƒ¡ áƒ›áƒáƒ‘áƒ˜áƒšáƒ£áƒ áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡</p>
    <textarea id="codeOutput" readonly></textarea>
    <button class="btn btn-primary" onclick="copyHTML()">ğŸ“‹ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ</button>
</div>

<script>
    let staff = JSON.parse(localStorage.getItem('savedStaffContacts')) || [];

    function addStaff() {
        const n = document.getElementById('staffName'), p = document.getElementById('staffPhone');
        if(n.value.trim()) {
            staff.push({ name: n.value.trim(), phone: p.value.trim() || "" });
            staff.sort((a, b) => a.name.localeCompare(b.name, 'ka'));
            localStorage.setItem('savedStaffContacts', JSON.stringify(staff));
            n.value = ""; p.value = ""; renderStaffUI();
        }
    }

    function renderStaffUI() {
        document.getElementById('staffListUI').innerHTML = staff.map((s, i) => `
            <div style="background:rgba(255,255,255,0.1); padding:8px; margin-bottom:5px; display:flex; justify-content:space-between; font-size:12px; border-radius:4px;">
                ${s.name} <span onclick="removeStaff(${i})" style="color:#ff4d4d; cursor:pointer;">Ã—</span>
            </div>`).join('');
        document.getElementById('staffDatalist').innerHTML = staff.map(s => `<option value="${s.name}">`).join('');
    }

    function removeStaff(i) {
        staff.splice(i, 1);
        localStorage.setItem('savedStaffContacts', JSON.stringify(staff));
        renderStaffUI();
    }

    function updateUI() {
        const title = document.getElementById('topTitleInput').value || "áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜";
        const phones = document.getElementById('topPhoneInput').value;
        document.getElementById('displayTitle').innerText = title;
        const area = document.getElementById('displayHeaderPhone');
        if(phones) {
            area.innerHTML = phones.split(/[, ]+/).map(p => `<a href="tel:${p}" style="display:inline-block; color:white; background:#8b0000; text-decoration:none; padding:8px 12px; border-radius:20px; margin:3px; font-size:13px;">ğŸ“ ${p}</a>`).join('');
        } else area.innerHTML = "";
        syncCode();
    }

    function enableEdit(el, oldName) {
        const parent = el.parentElement;
        parent.innerHTML = `<input type="text" list="staffDatalist" style="color:#333; width:100%" value="${oldName}" onchange="saveEdit(this)" onblur="saveEdit(this)">`;
        parent.querySelector('input').focus();
    }

    function saveEdit(input) {
        const name = input.value;
        const p = staff.find(s => s.name === name);
        const parent = input.parentElement;
        parent.innerHTML = `<span class="editable-name" onclick="enableEdit(this, '${name}')">${name}</span>
                            <a href="tel:${p?p.phone:''}" class="phone-display">ğŸ“ ${p?p.phone:'---'}</a>`;
        syncCode();
    }

    function generateNew() {
        const s = document.getElementById('startMonth').value;
        const e = document.getElementById('endMonth').value;
        if(!s || !e || staff.length === 0) return alert("áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜!");

        let cur = new Date(Date.UTC(s.split('-')[0], s.split('-')[1]-1, 1));
        const end = new Date(Date.UTC(e.split('-')[0], e.split('-')[1], 0));
        
        let html = "";
        let idx = 0;
        const months = ["áƒ˜áƒáƒœáƒ•áƒáƒ áƒ˜", "áƒ—áƒ”áƒ‘áƒ”áƒ áƒ•áƒáƒšáƒ˜", "áƒ›áƒáƒ áƒ¢áƒ˜", "áƒáƒáƒ áƒ˜áƒšáƒ˜", "áƒ›áƒáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒœáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒšáƒ˜áƒ¡áƒ˜", "áƒáƒ’áƒ•áƒ˜áƒ¡áƒ¢áƒ", "áƒ¡áƒ”áƒ¥áƒ¢áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒáƒ¥áƒ¢áƒáƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒœáƒáƒ”áƒ‘áƒ”áƒ áƒ˜", "áƒ“áƒ”áƒ™áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜"];

        while(cur <= end) {
            if(cur.getUTCDate() === 1) {
                if(html !== "") html += "</tbody></table>";
                html += `<h3 style="color:#8b0000; background:#f1f4f8; padding:10px">${months[cur.getUTCMonth()]} ${cur.getUTCFullYear()}</h3>
                         <table><thead><tr><th style="width:15%">áƒ“áƒ¦áƒ”</th><th style="width:25%">áƒ“áƒ áƒ</th><th>áƒ›áƒáƒ áƒ˜áƒ’áƒ”</th></tr></thead><tbody>`;
            }
            const isW = cur.getUTCDay() === 0 || cur.getUTCDay() === 6;
            const p = staff[idx % staff.length];
            html += `<tr class="${isW?'weekend':''}">
                <td><b>${cur.getUTCDate()}</b></td>
                <td><small>${isW?'08:00-03:00':'18:00-03:00'}</small></td>
                <td><span class="editable-name" onclick="enableEdit(this,'${p.name}')">${p.name}</span>
                    <a href="tel:${p.phone}" class="phone-display">ğŸ“ ${p.phone}</a></td></tr>`;
            idx++;
            cur.setUTCDate(cur.getUTCDate() + 1);
        }
        document.getElementById('scheduleContainer').innerHTML = html + "</tbody></table>";
        syncCode();
    }

    function syncCode() {
        const title = document.getElementById('displayTitle').innerText;
        const phones = document.getElementById('displayHeaderPhone').innerHTML;
        const style = `<style>
            body{font-family:sans-serif; background:#f4f4f4; padding:15px; margin:0;}
            .t{color:#8b0000; text-align:center; font-size:24px; font-weight:bold; margin-bottom:15px;}
            .p-cont{text-align:center; margin-bottom:20px;}
            table{width:100%; border-collapse:collapse; background:white; margin-bottom:20px;}
            th,td{border:1px solid #ddd; padding:12px; text-align:left;}
            .weekend{background:#fff5f5; color:#ef233c;}
            a{color:#4361ee; text-decoration:none; font-weight:bold;}
            @media (max-width: 600px) {
                table, thead, tbody, th, td, tr { display: block; }
                thead tr { position: absolute; top: -9999px; left: -9999px; }
                tr { border: 1px solid #ccc; margin-bottom: 12px; border-radius: 8px; background: white; }
                td { border: none; position: relative; padding-left: 50%; border-bottom: 1px solid #eee; min-height: 40px; }
                td:before { position: absolute; left: 10px; width: 45%; font-weight: bold; color: #666; }
                td:nth-of-type(1):before { content: "áƒ áƒ˜áƒªáƒ®áƒ•áƒ˜:"; }
                td:nth-of-type(2):before { content: "áƒ“áƒ áƒ:"; }
                td:nth-of-type(3):before { content: "áƒ›áƒáƒ áƒ˜áƒ’áƒ”:"; }
            }
        </style>`;
        
        let container = document.getElementById('scheduleContainer').cloneNode(true);
        container.querySelectorAll('.editable-name').forEach(el => {
            let b = document.createElement('b'); b.innerText = el.innerText;
            el.parentNode.replaceChild(b, el);
        });

        const finalHTML = `<!DOCTYPE html><html><head>
            <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">${style}
            </head><body><div class="t">${title}</div><div class="p-cont">${phones}</div>${container.innerHTML}</body></html>`;
        
        document.getElementById('codeOutput').value = finalHTML;
    }

    function copyHTML() {
        document.getElementById("codeOutput").select();
        document.execCommand("copy");
        alert("áƒ™áƒáƒ“áƒ˜ áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ“áƒ! áƒáƒ®áƒšáƒ áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒáƒ— áƒ©áƒáƒ¡áƒ•áƒáƒ— áƒœáƒ”áƒ‘áƒ˜áƒ¡áƒ›áƒ˜áƒ”áƒ  áƒ¤áƒáƒ˜áƒšáƒ¨áƒ˜.");
    }

    window.onload = () => {
        const d = new Date();
        document.getElementById('startMonth').value = d.toISOString().slice(0, 7);
        document.getElementById('endMonth').value = d.toISOString().slice(0, 7);
        renderStaffUI();
    };
</script>
</body>
</html>
